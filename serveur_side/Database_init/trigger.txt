table ->

CREATE TABLE IF NOT EXISTS Entreprise_Full (
    user_id VARCHAR(36),
    email TEXT,
    password TEXT,
    telephone TEXT,
    role TEXT,
    account_status TEXT,
    entreprise_id VARCHAR(36),
    nom_entreprise TEXT,
    description TEXT,
    adresse TEXT,
    logopath TEXT,
    siteweb TEXT
);


procedure : DROP PROCEDURE IF EXISTS create_general_entreprise;
DELIMITER //

CREATE PROCEDURE create_general_entreprise(IN p_user_id VARCHAR(36), IN logo_path varchar(500))
BEGIN
    INSERT INTO Entreprise_Full (
        user_id,
        email,
        password,
        telephone,
        role,
        account_status,
        entreprise_id,
        nom_entreprise,
        description,
        adresse,
        logopath,
        siteweb
    )
    SELECT
        u.user_id,
        u.email,
        u.password,
        u.telephone,
        u.role,
        u.account_status,
        e.entreprise_id,
        e.nom_entreprise,
        e.description,
        e.adresse,
        logo_path,
        e.siteweb
    FROM Utilisateurs u
    JOIN Entreprises e
        ON e.entreprise_id = u.user_id
    WHERE u.user_id = p_user_id
      AND u.role = 'Entreprise';
END//

DELIMITER ;

call : CALL create_general_entreprise(
    'user-id-here',
    '/uploads/logos/company.png'
);
 |  $stmt = $pdo->prepare("CALL create_general_entreprise(:uid, :logo)");
$stmt->execute([
    ':uid'  => $userId,
    ':logo' => $logoPath
]);
$stmt->closeCursor();


trigger : 

DELIMITER //

CREATE TRIGGER trg_create_entreprise_full
AFTER INSERT ON Utilisateurs
FOR EACH ROW
BEGIN
    IF NEW.role = 'Entreprise' THEN
        INSERT INTO Entreprise_Full (
            user_id, email, password, telephone, role, account_status,
            entreprise_id, nom_entreprise, description, adresse, logopath, siteweb
        )
        SELECT
            NEW.user_id,
            NEW.email,
            NEW.password,
            NEW.telephone,
            NEW.role,
            NEW.account_status,
            e.entreprise_id,
            e.nom_entreprise,
            e.description,
            e.adresse,
            e.logopath,
            e.siteweb
        FROM Entreprises e
        WHERE e.entreprise_id = NEW.user_id;
    END IF;
END//

DELIMITER ;



php call : 
1 _

$stmt = $pdo->prepare("SELECT * FROM Entreprise_Full WHERE user_id = :user_id");
$stmt->execute([
    ':user_id' => $userId
]);

$entreprise = $stmt->fetch(PDO::FETCH_ASSOC);

2_ 

$stmt = $pdo->prepare("CALL create_general_entreprise(:user_id)");
$stmt->execute([
    ':user_id' => $userId
]);

$stmt->closeCursor();

fetch | $stmt = $pdo->query("SELECT * FROM Entreprise_Full WHERE user_id = '$userId'");
$data = $stmt->fetch(PDO::FETCH_ASSOC);


3_

after insert into user 

insert into stagiaire
insert into_entreprise

logic endarant



$Utilisateurs = "
    CREATE TABLE IF NOT EXISTS Utilisateurs (
        user_id CHAR(36) NOT NULL PRIMARY KEY,
        email VARCHAR(255) NOT NULL UNIQUE,
        password_hash VARCHAR(255) NOT NULL,
        telephone VARCHAR(20),
        role ENUM('Stagiaire', 'Entreprise', 'Encadrant', 'Admin') NOT NULL,
        account_status ENUM('Pending', 'Active', 'Verified', 'Blocked') DEFAULT 'Pending',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    );
";

// 2. Table StagiaireAccounts
// - PK is CHAR(36) because it matches Utilisateurs.user_id
$StagiaireAccount = "
    CREATE TABLE IF NOT EXISTS StagiaireAccounts (
        stagiaire_id CHAR(36) NOT NULL PRIMARY KEY,
        nom VARCHAR(100) NOT NULL,
        prenom VARCHAR(100) NOT NULL,
        cv_path VARCHAR(255),
        photo_path VARCHAR(255),
        FOREIGN KEY (stagiaire_id) REFERENCES Utilisateurs(user_id) ON DELETE CASCADE
    );
";

// 3. Table Entreprises
// - PK is CHAR(36)
$Entreprises = "
    CREATE TABLE IF NOT EXISTS Entreprises (
        entreprise_id CHAR(36) NOT NULL PRIMARY KEY,
        nom_entreprise VARCHAR(150) NOT NULL,
        description TEXT,
        adresse VARCHAR(255),
        logo_path VARCHAR(255),
        site_web VARCHAR(255),
        UNIQUE(nom_entreprise), 
        FOREIGN KEY (entreprise_id) REFERENCES Utilisateurs(user_id) ON DELETE CASCADE
    );
";



// 4. Table Encadrants
// - PK is CHAR(36)
// - agence_id must be CHAR(36) to reference Entreprises
$Encadrants = "
    CREATE TABLE IF NOT EXISTS Encadrants (
        encadrant_id CHAR(36) NOT NULL PRIMARY KEY,
        nom VARCHAR(100) NOT NULL,
        prenom VARCHAR(100) NOT NULL,
        agence_id CHAR(36), 
        nom_d_agence VARCHAR(150) NOT NULL,
        departement VARCHAR(100),
        status_d_encadrant VARCHAR(100),
        
        FOREIGN KEY (encadrant_id) REFERENCES Utilisateurs(user_id) ON DELETE CASCADE,
        FOREIGN KEY (agence_id) REFERENCES Entreprises(entreprise_id),
        
        INDEX(agence_id)
    );
";

triiger

DELIMITER $$

CREATE TRIGGER after_utilisateur_insert
AFTER INSERT ON Utilisateurs
FOR EACH ROW
BEGIN
    CASE NEW.role
        WHEN 'Stagiaire' THEN
            INSERT INTO StagiaireAccounts (stagiaire_id, nom, prenom)
            VALUES (NEW.user_id, 'Unknown', 'Unknown');

        WHEN 'Encadrant' THEN
            INSERT INTO Encadrants (
                encadrant_id, nom, prenom, nom_d_agence
            )
            VALUES (
                NEW.user_id, 'Unknown', 'Unknown', 'Unknown'
            );

        WHEN 'Entreprise' THEN
            INSERT INTO Entreprises (
                entreprise_id, nom_entreprise
            )
            VALUES (
                NEW.user_id, 'Unknown'
            );
    END CASE;
END$$

DELIMITER ;

stage evaluatio - modification des donnes - cv - et photo - affectation des candidature - rapports



DELIMITER $$

CREATE TRIGGER after_utilisateur_insert
AFTER INSERT ON Utilisateurs
FOR EACH ROW
BEGIN
    CASE NEW.role
        WHEN 'Stagiaire' THEN
            INSERT INTO StagiaireAccounts (stagiaire_id, nom, prenom)
            VALUES (NEW.user_id, 'Unknown', 'Unknown');

        WHEN 'Encadrant' THEN
            INSERT INTO Encadrants (
                encadrant_id, nom, prenom, nom_d_agence
            )
            VALUES (
                NEW.user_id, 'Unknown', 'Unknown', 'Unknown'
            );

        WHEN 'Entreprise' THEN
            INSERT INTO Entreprises (
                entreprise_id, nom_entreprise
            )
            VALUES (
                NEW.user_id, 'Unknown'
            );
    END CASE;
END$$

DELIMITER ;


rapport - modification profile - admin - entreprise -update - notification